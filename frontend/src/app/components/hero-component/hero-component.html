<div class="hero-container">
  <div class="hero-content">
    <ng-container *ngIf="character$ | async as character; else noCharacter">
      <div class="character-card">
        
        <!-- Hero Header -->
        <div class="hero-header">
          <div class="character-avatar">
            <img [src]="'assets/characters/' + (character.profileIconUrl ? character.profileIconUrl.split('/').pop() : 'char1.jpeg')" alt="Character Icon" class="avatar-image" (error)="onImageError($event)" />
            <div class="level-badge">{{ character.level }}</div>
          </div>
          
          <div class="character-info">
            <h1 class="character-name">{{ character.name }}</h1>
            <div class="character-class">{{ character.class | titlecase }}</div>
            <div class="character-xp">XP: {{ character.experiencePoints }}</div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button
              *ngIf="!editMode && character.canAllocateStats"
              class="levelup-btn"
              type="button"
              (click)="enterAllocateMode(character)"
              title="Allocate stat points">
              <span class="btn-icon">‚ö°</span>
              Level Up
            </button>

            <div *ngIf="editMode" class="edit-actions">
              <button class="save-btn" type="button" [disabled]="pointsRemaining !== 0 || saving" (click)="save(character)">
                <span class="btn-icon">üíæ</span>
                {{ saving ? 'Saving...' : 'Save' }}
              </button>
              <button class="cancel-btn" type="button" [disabled]="saving" (click)="cancel()">
                <span class="btn-icon">‚ùå</span>
                Cancel
              </button>
            </div>
          </div>
        </div>

        <!-- View mode (read-only) -->
        <ng-container *ngIf="!editMode; else allocateUI">
          <div class="stats-grid">
            <!-- Health & Energy Bars -->
            <div class="stat-section health-section">
              <div class="stat-header">
                <span class="stat-icon">‚ù§Ô∏è</span>
                <span class="stat-label">Health</span>
                <span class="stat-value">{{ character.currentHealth }} / {{ character.maxHealth }}</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill health" [style.width.%]="(character.currentHealth / character.maxHealth) * 100"></div>
              </div>
            </div>

            <div class="stat-section energy-section">
              <div class="stat-header">
                <span class="stat-icon">‚ö°</span>
                <span class="stat-label">Energy</span>
                <span class="stat-value">{{ character.currentEnergy }} / {{ character.maxEnergy }}</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill energy" [style.width.%]="(character.currentEnergy / character.maxEnergy) * 100"></div>
              </div>
            </div>

            <!-- Combat Stats -->
            <div class="stat-section combat-stats">
              <h3 class="section-title">Combat Stats</h3>
              <div class="stats-row">
                <div class="stat-item">
                  <span class="stat-icon">‚öîÔ∏è</span>
                  <span class="stat-label">Attack</span>
                  <span class="stat-value">
                    <ng-container *ngIf="formatStatDisplayForUI(character, 'attack').hasBonus; else simpleAttack">
                      {{ formatStatDisplayForUI(character, 'attack').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'attack').bonus }}</span>
                    </ng-container>
                    <ng-template #simpleAttack>
                      {{ formatStatDisplayForUI(character, 'attack').total }}
                    </ng-template>
                  </span>
                </div>
                <div class="stat-item">
                  <span class="stat-icon">üõ°Ô∏è</span>
                  <span class="stat-label">Defense</span>
                  <span class="stat-value">
                    <ng-container *ngIf="formatStatDisplayForUI(character, 'defense').hasBonus; else simpleDefense">
                      {{ formatStatDisplayForUI(character, 'defense').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'defense').bonus }}</span>
                    </ng-container>
                    <ng-template #simpleDefense>
                      {{ formatStatDisplayForUI(character, 'defense').total }}
                    </ng-template>
                  </span>
                </div>
                <div class="stat-item">
                  <span class="stat-icon">üí®</span>
                  <span class="stat-label">Agility</span>
                  <span class="stat-value">
                    <ng-container *ngIf="formatStatDisplayForUI(character, 'agility').hasBonus; else simpleAgility">
                      {{ formatStatDisplayForUI(character, 'agility').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'agility').bonus }}</span>
                    </ng-container>
                    <ng-template #simpleAgility>
                      {{ formatStatDisplayForUI(character, 'agility').total }}
                    </ng-template>
                  </span>
                </div>
                <div class="stat-item">
                  <span class="stat-icon">üîÆ</span>
                  <span class="stat-label">Magic</span>
                  <span class="stat-value">
                    <ng-container *ngIf="formatStatDisplayForUI(character, 'magic').hasBonus; else simpleMagic">
                      {{ formatStatDisplayForUI(character, 'magic').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'magic').bonus }}</span>
                    </ng-container>
                    <ng-template #simpleMagic>
                      {{ formatStatDisplayForUI(character, 'magic').total }}
                    </ng-template>
                  </span>
                </div>
                <div class="stat-item">
                  <span class="stat-icon">üèÉ</span>
                  <span class="stat-label">Speed</span>
                  <span class="stat-value">
                    <ng-container *ngIf="formatStatDisplayForUI(character, 'speed').hasBonus; else simpleSpeed">
                      {{ formatStatDisplayForUI(character, 'speed').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'speed').bonus }}</span>
                    </ng-container>
                    <ng-template #simpleSpeed>
                      {{ formatStatDisplayForUI(character, 'speed').total }}
                    </ng-template>
                  </span>
                </div>
                <div class="stat-item">
                  <span class="stat-icon">üí•</span>
                  <span class="stat-label">Crit Chance</span>
                  <span class="stat-value">{{ (character.criticalChance * 100).toFixed(1) }}%</span>
                </div>
              </div>
            </div>

            <!-- Resources -->
            <div class="stat-section resources">
              <h3 class="section-title">Resources</h3>
              <div class="resources-row">
                <div class="resource-item">
                  <span class="resource-icon">üí∞</span>
                  <span class="resource-label">Credits</span>
                  <span class="resource-value">{{ character.credits | number }}</span>
                </div>
                <div class="resource-item">
                  <span class="resource-icon">üìÖ</span>
                  <span class="resource-label">Created</span>
                  <span class="resource-value">{{ character.createdAt | date:'MMM d, y' }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Allocate mode -->
        <ng-template #allocateUI>
          <div class="allocate-mode">
            <div class="allocate-header">
              <div class="points-remaining">
                <span class="points-icon">‚≠ê</span>
                <span class="points-text">Points Remaining: {{ pointsRemaining }}</span>
              </div>
              <div class="allocate-hint">Distribute all {{ pointsRemaining }} points to save your changes</div>
            </div>

            <div class="allocate-grid">
              <div class="allocate-item">
                <div class="allocate-header-item">
                  <span class="allocate-icon">‚ù§Ô∏è</span>
                  <span class="allocate-label">Health</span>
                </div>
                <div class="allocate-controls">
                  <button type="button" class="allocate-btn minus" (click)="decrement('hp')" [disabled]="saving || allocatedHpPoints() === 0">-</button>
                  <div class="allocate-value">
                    {{ editedMaxHealth }}
                    <small *ngIf="allocatedHpPoints() > 0" class="allocate-bonus">+{{ allocatedHpPoints() * HP_PER_POINT }}</small>
                  </div>
                  <button type="button" class="allocate-btn plus" (click)="increment('hp')" [disabled]="saving || pointsRemaining === 0">+</button>
                </div>
              </div>

              <div class="allocate-item" *ngFor="let stat of statKeys">
                <div class="allocate-header-item">
                  <span class="allocate-icon">{{ getStatIcon(stat) }}</span>
                  <span class="allocate-label">{{ stat | titlecase }}</span>
                </div>
                <div class="allocate-controls">
                  <button type="button" class="allocate-btn minus" (click)="decrement(stat)" [disabled]="saving || allocated(stat) === 0">-</button>
                  <div class="allocate-value">
                    {{ editedStats[stat] }}
                    <small *ngIf="allocated(stat) > 0" class="allocate-bonus">+{{ allocated(stat) }}</small>
                  </div>
                  <button type="button" class="allocate-btn plus" (click)="increment(stat)" [disabled]="saving || pointsRemaining === 0">+</button>
                </div>
              </div>
            </div>
          </div>
        </ng-template>

      </div>
    </ng-container>

    <ng-template #noCharacter>
      <div class="empty-state">
        <div class="empty-icon">üë§</div>
        <h2 class="empty-title">No Character Found</h2>
        <p class="empty-description">Create your first character to start your adventure!</p>
        <a routerLink="/create-character" class="create-character-btn">
          <span class="btn-icon">‚ú®</span>
          Create Character
        </a>
      </div>
    </ng-template>
  </div>
</div>
