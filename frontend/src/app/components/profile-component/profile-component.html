<div class="profile-container">
  <div class="profile-content">
    <ng-container *ngIf="user$ | async as user; else loading">
      
      <!-- User Profile Section -->
      <div class="profile-section">
        <div class="profile-card user-card">
          <div class="card-header">
            <div class="user-avatar">
              <img [src]="user.profilePictureUrl" alt="Profile Picture" class="avatar-image" />
              <div class="user-level-badge">{{ user.level }}</div>
            </div>
            <div class="user-info">
              <h1 class="username">{{ user.username }}</h1>
              <p class="fullname">{{ user.fullName }}</p>
              <div class="user-role">{{ user.role | titlecase }}</div>
            </div>
          </div>
          
          <div class="card-content">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-info">
                  <div class="stat-label">Experience</div>
                  <div class="stat-value">{{ user.experiencePoints | number }}</div>
                </div>
              </div>
              
              <div class="stat-item">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                  <div class="stat-label">Credits</div>
                  <div class="stat-value">{{ user.credits | number }}</div>
                </div>
              </div>
              
              <div class="stat-item">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-info">
                  <div class="stat-label">Achievements</div>
                  <div class="stat-value">{{ achievementsCount$ | async }}</div>
                </div>
              </div>
              
              <div class="stat-item">
                <div class="stat-icon">‚ú®</div>
                <div class="stat-info">
                  <div class="stat-label">Cosmetics</div>
                  <div class="stat-value">{{ cosmeticsCount$ | async }}</div>
                </div>
              </div>
            </div>
            
            <div class="user-meta">
              <div class="meta-item">
                <span class="meta-icon">üìÖ</span>
                <span class="meta-text">Joined {{ user.createdAt | date:'MMM d, y' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Character Profile Section -->
      <div class="profile-section">
        <ng-container *ngIf="character$ | async as character; else noCharacter">
          <div class="profile-card character-card">
            <div class="card-header">
              <div class="character-avatar">
                <img [src]="'assets/characters/' + (character.profileIconUrl ? character.profileIconUrl.split('/').pop() : 'char1.jpeg')" alt="Character Image" class="avatar-image" (error)="onImageError($event)" />
                <div class="character-level-badge">{{ character.level }}</div>
              </div>
              <div class="character-info">
                <h2 class="character-name">{{ character.name || 'Unnamed Character' }}</h2>
                <div class="character-class">{{ character.class | titlecase }}</div>
                <div class="character-xp">XP: {{ character.experiencePoints | number }}</div>
              </div>
            </div>
            
            <div class="card-content">
              <!-- Health & Energy -->
              <div class="character-bars">
                <div class="bar-section">
                  <div class="bar-header">
                    <span class="bar-icon">‚ù§Ô∏è</span>
                    <span class="bar-label">Health</span>
                    <span class="bar-value">{{ character.currentHealth }} / {{ character.maxHealth }}</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill health" [style.width.%]="(character.currentHealth / character.maxHealth) * 100"></div>
                  </div>
                </div>
                
                <div class="bar-section">
                  <div class="bar-header">
                    <span class="bar-icon">‚ö°</span>
                    <span class="bar-label">Energy</span>
                    <span class="bar-value">{{ character.currentEnergy }} / {{ character.maxEnergy }}</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill energy" [style.width.%]="(character.currentEnergy / character.maxEnergy) * 100"></div>
                  </div>
                </div>
              </div>
              
              <!-- Combat Stats -->
              <div class="combat-stats">
                <h3 class="section-title">Combat Statistics</h3>
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-icon">‚öîÔ∏è</span>
                    <span class="stat-label">Attack</span>
                    <span class="stat-value">
                      <ng-container *ngIf="formatStatDisplayForUI(character, 'attack').hasBonus; else simpleAttack">
                        {{ formatStatDisplayForUI(character, 'attack').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'attack').bonus }}</span>
                      </ng-container>
                      <ng-template #simpleAttack>
                        {{ formatStatDisplayForUI(character, 'attack').total }}
                      </ng-template>
                    </span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-icon">üõ°Ô∏è</span>
                    <span class="stat-label">Defense</span>
                    <span class="stat-value">
                      <ng-container *ngIf="formatStatDisplayForUI(character, 'defense').hasBonus; else simpleDefense">
                        {{ formatStatDisplayForUI(character, 'defense').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'defense').bonus }}</span>
                      </ng-container>
                      <ng-template #simpleDefense>
                        {{ formatStatDisplayForUI(character, 'defense').total }}
                      </ng-template>
                    </span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-icon">üí®</span>
                    <span class="stat-label">Agility</span>
                    <span class="stat-value">
                      <ng-container *ngIf="formatStatDisplayForUI(character, 'agility').hasBonus; else simpleAgility">
                        {{ formatStatDisplayForUI(character, 'agility').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'agility').bonus }}</span>
                      </ng-container>
                      <ng-template #simpleAgility>
                        {{ formatStatDisplayForUI(character, 'agility').total }}
                      </ng-template>
                    </span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-icon">üîÆ</span>
                    <span class="stat-label">Magic</span>
                    <span class="stat-value">
                      <ng-container *ngIf="formatStatDisplayForUI(character, 'magic').hasBonus; else simpleMagic">
                        {{ formatStatDisplayForUI(character, 'magic').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'magic').bonus }}</span>
                      </ng-container>
                      <ng-template #simpleMagic>
                        {{ formatStatDisplayForUI(character, 'magic').total }}
                      </ng-template>
                    </span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-icon">üèÉ</span>
                    <span class="stat-label">Speed</span>
                    <span class="stat-value">
                      <ng-container *ngIf="formatStatDisplayForUI(character, 'speed').hasBonus; else simpleSpeed">
                        {{ formatStatDisplayForUI(character, 'speed').total }} <span class="stat-bonus">| {{ formatStatDisplayForUI(character, 'speed').bonus }}</span>
                      </ng-container>
                      <ng-template #simpleSpeed>
                        {{ formatStatDisplayForUI(character, 'speed').total }}
                      </ng-template>
                    </span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-icon">üí•</span>
                    <span class="stat-label">Crit Chance</span>
                    <span class="stat-value">{{ (character.criticalChance * 100).toFixed(1) }}%</span>
                  </div>
                </div>
              </div>
              
              <!-- Character Meta -->
              <div class="character-meta">
                <div class="meta-item">
                  <span class="meta-icon">üí∞</span>
                  <span class="meta-text">Credits: {{ character.credits | number }}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-icon">üìÖ</span>
                  <span class="meta-text">Created: {{ character.createdAt | date:'MMM d, y' }}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-icon">üîÑ</span>
                  <span class="meta-text">Updated: {{ character.updatedAt | date:'MMM d, y' }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- No Character State -->
        <ng-template #noCharacter>
          <div class="profile-card character-card empty-character">
            <div class="empty-state">
              <div class="empty-icon">üë§</div>
              <h3 class="empty-title">No Character</h3>
              <p class="empty-description">This user hasn't created a character yet.</p>
            </div>
          </div>
        </ng-template>
      </div>

    </ng-container>

    <!-- Loading State -->
    <ng-template #loading>
      <div class="loading-container">
        <app-loading-spinner></app-loading-spinner>
      </div>
    </ng-template>

  </div>
</div>
